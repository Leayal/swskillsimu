function deleteRenderTarget(e){gl.deleteFramebuffer(e.frameBuffer),gl.deleteRenderbuffer(e.renderBuffer),gl.deleteTexture(e.texture)}function createRenderTarget(e,r){var t={width:e,height:r,sizeArray:new Float32Array([e,r,e/r]),dtxArray:new Float32Array([1/e,1/r])};return t.frameBuffer=gl.createFramebuffer(),t.renderBuffer=gl.createRenderbuffer(),t.texture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,t.texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,e,r,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.bindFramebuffer(gl.FRAMEBUFFER,t.frameBuffer),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,t.texture,0),gl.bindRenderbuffer(gl.RENDERBUFFER,t.renderBuffer),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,e,r),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,t.renderBuffer),gl.bindTexture(gl.TEXTURE_2D,null),gl.bindRenderbuffer(gl.RENDERBUFFER,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null),t}function compileShader(e,r){var t=gl.createShader(e);if(gl.shaderSource(t,r),gl.compileShader(t),!gl.getShaderParameter(t,gl.COMPILE_STATUS)){var o=gl.getShaderInfoLog(t);return gl.deleteShader(t),console.error(o),null}return t}function createShader(e,r,t,o){var a=compileShader(gl.VERTEX_SHADER,e),n=compileShader(gl.FRAGMENT_SHADER,r);if(null==a||null==n)return null;var i=gl.createProgram();if(gl.attachShader(i,a),gl.attachShader(i,n),gl.deleteShader(a),gl.deleteShader(n),gl.linkProgram(i),!gl.getProgramParameter(i,gl.LINK_STATUS)){var l=gl.getProgramInfoLog(i);return console.error(l),null}if(t){i.uniforms={};for(f=0;f<t.length;f++)i.uniforms[t[f]]=gl.getUniformLocation(i,t[f])}if(o){i.attributes={};for(var f=0;f<o.length;f++){var c=o[f];i.attributes[c]=gl.getAttribLocation(i,c)}}return i}function useShader(e){gl.useProgram(e);for(var r in e.attributes)gl.enableVertexAttribArray(e.attributes[r])}function unuseShader(e){for(var r in e.attributes)gl.disableVertexAttribArray(e.attributes[r]);gl.useProgram(null)}function createPointFlowers(){var e=gl.getParameter(gl.ALIASED_POINT_SIZE_RANGE);renderSpec.pointSize={min:e[0],max:e[1]};var r=window.sakura_point_vsh,t=window.sakura_point_fsh;pointFlower.program=createShader(r,t,["uProjection","uModelview","uResolution","uOffset","uDOF","uFade"],["aPosition","aEuler","aMisc"]),useShader(pointFlower.program),pointFlower.offset=new Float32Array([0,0,0]),pointFlower.fader=Vector3.create(0,10,0),pointFlower.numFlowers=1600,pointFlower.particles=new Array(pointFlower.numFlowers),pointFlower.dataArray=new Float32Array(8*pointFlower.numFlowers),pointFlower.positionArrayOffset=0,pointFlower.eulerArrayOffset=3*pointFlower.numFlowers,pointFlower.miscArrayOffset=6*pointFlower.numFlowers,pointFlower.buffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,pointFlower.buffer),gl.bufferData(gl.ARRAY_BUFFER,pointFlower.dataArray,gl.DYNAMIC_DRAW),gl.bindBuffer(gl.ARRAY_BUFFER,null),unuseShader(pointFlower.program);for(var o=0;o<pointFlower.numFlowers;o++)pointFlower.particles[o]=new BlossomParticle}function initPointFlowers(){pointFlower.area=Vector3.create(20,20,20),pointFlower.area.x=pointFlower.area.y*renderSpec.aspect,pointFlower.fader.x=10,pointFlower.fader.y=pointFlower.area.z,pointFlower.fader.z=.1;for(var e=2*Math.PI,r=Vector3.create(0,0,0),t=0,o=function(){return 2*Math.random()-1},a=0;a<pointFlower.numFlowers;a++){var n=pointFlower.particles[a];r.x=.3*o()+.8,r.y=.2*o()-1,r.z=.3*o()+.5,Vector3.normalize(r),t=2+1*Math.random(),n.setVelocity(r.x*t,r.y*t,r.z*t),n.setRotation(o()*e*.5,o()*e*.5,o()*e*.5),n.setPosition(o()*pointFlower.area.x,o()*pointFlower.area.y,o()*pointFlower.area.z),n.setEulerAngles(Math.random()*Math.PI*2,Math.random()*Math.PI*2,Math.random()*Math.PI*2),n.setSize(.9+.1*Math.random())}}function renderPointFlowers(){for(var e=2*Math.PI,r=(pointFlower.area.x,pointFlower.area.y,pointFlower.area.z,function(e,r,t){Math.abs(e.position[r])-.5*e.size>t&&(e.position[r]>0?e.position[r]-=2*t:e.position[r]+=2*t)}),t=function(r,t){r.euler[t]=r.euler[t]%e,r.euler[t]<0&&(r.euler[t]+=e)},o=0;o<pointFlower.numFlowers;o++)(l=pointFlower.particles[o]).update(timeInfo.delta,timeInfo.elapsed),r(l,0,pointFlower.area.x),r(l,1,pointFlower.area.y),r(l,2,pointFlower.area.z),t(l,0),t(l,1),t(l,2),l.alpha=1,l.zkey=camera.matrix[2]*l.position[0]+camera.matrix[6]*l.position[1]+camera.matrix[10]*l.position[2]+camera.matrix[14];pointFlower.particles.sort(function(e,r){return e.zkey-r.zkey});for(var a=pointFlower.positionArrayOffset,n=pointFlower.eulerArrayOffset,i=pointFlower.miscArrayOffset,o=0;o<pointFlower.numFlowers;o++){var l=pointFlower.particles[o];pointFlower.dataArray[a]=l.position[0],pointFlower.dataArray[a+1]=l.position[1],pointFlower.dataArray[a+2]=l.position[2],a+=3,pointFlower.dataArray[n]=l.euler[0],pointFlower.dataArray[n+1]=l.euler[1],pointFlower.dataArray[n+2]=l.euler[2],n+=3,pointFlower.dataArray[i]=l.size,pointFlower.dataArray[i+1]=l.alpha,i+=2}gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);var f=pointFlower.program;useShader(f),gl.uniformMatrix4fv(f.uniforms.uProjection,!1,projection.matrix),gl.uniformMatrix4fv(f.uniforms.uModelview,!1,camera.matrix),gl.uniform3fv(f.uniforms.uResolution,renderSpec.array),gl.uniform3fv(f.uniforms.uDOF,Vector3.arrayForm(camera.dof)),gl.uniform3fv(f.uniforms.uFade,Vector3.arrayForm(pointFlower.fader)),gl.bindBuffer(gl.ARRAY_BUFFER,pointFlower.buffer),gl.bufferData(gl.ARRAY_BUFFER,pointFlower.dataArray,gl.DYNAMIC_DRAW),gl.vertexAttribPointer(f.attributes.aPosition,3,gl.FLOAT,!1,0,pointFlower.positionArrayOffset*Float32Array.BYTES_PER_ELEMENT),gl.vertexAttribPointer(f.attributes.aEuler,3,gl.FLOAT,!1,0,pointFlower.eulerArrayOffset*Float32Array.BYTES_PER_ELEMENT),gl.vertexAttribPointer(f.attributes.aMisc,2,gl.FLOAT,!1,0,pointFlower.miscArrayOffset*Float32Array.BYTES_PER_ELEMENT);for(o=1;o<2;o++){var c=-2*o;pointFlower.offset[0]=-1*pointFlower.area.x,pointFlower.offset[1]=-1*pointFlower.area.y,pointFlower.offset[2]=pointFlower.area.z*c,gl.uniform3fv(f.uniforms.uOffset,pointFlower.offset),gl.drawArrays(gl.POINT,0,pointFlower.numFlowers),pointFlower.offset[0]=-1*pointFlower.area.x,pointFlower.offset[1]=1*pointFlower.area.y,pointFlower.offset[2]=pointFlower.area.z*c,gl.uniform3fv(f.uniforms.uOffset,pointFlower.offset),gl.drawArrays(gl.POINT,0,pointFlower.numFlowers),pointFlower.offset[0]=1*pointFlower.area.x,pointFlower.offset[1]=-1*pointFlower.area.y,pointFlower.offset[2]=pointFlower.area.z*c,gl.uniform3fv(f.uniforms.uOffset,pointFlower.offset),gl.drawArrays(gl.POINT,0,pointFlower.numFlowers),pointFlower.offset[0]=1*pointFlower.area.x,pointFlower.offset[1]=1*pointFlower.area.y,pointFlower.offset[2]=pointFlower.area.z*c,gl.uniform3fv(f.uniforms.uOffset,pointFlower.offset),gl.drawArrays(gl.POINT,0,pointFlower.numFlowers)}pointFlower.offset[0]=0,pointFlower.offset[1]=0,pointFlower.offset[2]=0,gl.uniform3fv(f.uniforms.uOffset,pointFlower.offset),gl.drawArrays(gl.POINT,0,pointFlower.numFlowers),gl.bindBuffer(gl.ARRAY_BUFFER,null),unuseShader(f),gl.enable(gl.DEPTH_TEST),gl.disable(gl.BLEND)}function createEffectProgram(e,r,t,o){var a={},n=["uResolution","uSrc","uDelta"];t&&(n=n.concat(t));var i=["aPosition"];return o&&(i=i.concat(o)),a.program=createShader(e,r,n,i),useShader(a.program),a.dataArray=new Float32Array([-1,-1,1,-1,-1,1,1,1]),a.buffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,a.buffer),gl.bufferData(gl.ARRAY_BUFFER,a.dataArray,gl.STATIC_DRAW),gl.bindBuffer(gl.ARRAY_BUFFER,null),unuseShader(a.program),a}function useEffect(e,r){var t=e.program;useShader(t),gl.uniform3fv(t.uniforms.uResolution,renderSpec.array),null!=r&&(gl.uniform2fv(t.uniforms.uDelta,r.dtxArray),gl.uniform1i(t.uniforms.uSrc,0),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,r.texture))}function drawEffect(e){gl.bindBuffer(gl.ARRAY_BUFFER,e.buffer),gl.vertexAttribPointer(e.program.attributes.aPosition,2,gl.FLOAT,!1,0,0),gl.drawArrays(gl.TRIANGLE_STRIP,0,4)}function unuseEffect(e){unuseShader(e.program)}function createEffectLib(){var e=window.fx_common_vsh;effectLib.sceneBg=createEffectProgram(e,window.bg_fsh,["uTimes"],null),effectLib.mkBrightBuf=createEffectProgram(e,window.fx_brightbuf_fsh,null,null),effectLib.dirBlur=createEffectProgram(e,window.fx_dirblur_r4_fsh,["uBlurDir"],null),effectLib.finalComp=createEffectProgram(window.pp_final_vsh,window.pp_final_fsh,["uBloom"],null)}function createBackground(){}function initBackground(){}function renderBackground(){gl.disable(gl.DEPTH_TEST),useEffect(effectLib.sceneBg,null),gl.uniform2f(effectLib.sceneBg.program.uniforms.uTimes,timeInfo.elapsed,timeInfo.delta),drawEffect(effectLib.sceneBg),unuseEffect(effectLib.sceneBg),gl.enable(gl.DEPTH_TEST)}function createPostProcess(){}function initPostProcess(){}function renderPostProcess(){gl.enable(gl.TEXTURE_2D),gl.disable(gl.DEPTH_TEST);gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.viewport(0,0,renderSpec.width,renderSpec.height),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),useEffect(effectLib.finalComp,renderSpec.mainRT),gl.uniform1i(effectLib.finalComp.program.uniforms.uBloom,1),gl.activeTexture(gl.TEXTURE1),gl.bindTexture(gl.TEXTURE_2D,renderSpec.wHalfRT0.texture),drawEffect(effectLib.finalComp),unuseEffect(effectLib.finalComp),gl.enable(gl.DEPTH_TEST)}function createScene(){createEffectLib(),createBackground(),createPointFlowers(),createPostProcess(),sceneStandBy=!0}function initScene(){initBackground(),initPointFlowers(),initPostProcess(),camera.position.z=pointFlower.area.z+projection.nearfar[0],projection.angle=180*Math.atan2(pointFlower.area.y,camera.position.z+pointFlower.area.z)/Math.PI*2,Matrix44.loadProjection(projection.matrix,renderSpec.aspect,projection.angle,projection.nearfar[0],projection.nearfar[1])}function renderScene(){Matrix44.loadLookAt(camera.matrix,camera.position,camera.lookat,camera.up),gl.enable(gl.DEPTH_TEST),gl.bindFramebuffer(gl.FRAMEBUFFER,renderSpec.mainRT.frameBuffer),gl.viewport(0,0,renderSpec.mainRT.width,renderSpec.mainRT.height),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),renderBackground(),renderPointFlowers(),renderPostProcess()}function onResize(e){makeCanvasFullScreen(document.getElementById("sakura")),setViewports(),sceneStandBy&&initScene()}function setViewports(){renderSpec.setSize(gl.canvas.width,gl.canvas.height),gl.clearColor(0,0,0,0),gl.viewport(0,0,renderSpec.width,renderSpec.height);var e=function(e,r,t){var o=renderSpec[e];o&&deleteRenderTarget(o),renderSpec[e]=createRenderTarget(r,t)};e("mainRT",renderSpec.width,renderSpec.height),e("wFullRT0",renderSpec.width,renderSpec.height),e("wFullRT1",renderSpec.width,renderSpec.height),e("wHalfRT0",renderSpec.halfWidth,renderSpec.halfHeight),e("wHalfRT1",renderSpec.halfWidth,renderSpec.halfHeight)}function render(){renderScene()}function toggleAnimation(){return(animating^=!0)&&animate(),animating}function playAnimation(){animating||(animating=!0,animate())}function stopAnimation(){animating&&(animating=!1)}function stepAnimation(){animating||animate()}function animate(){var e=new Date;timeInfo.elapsed=(e-timeInfo.start)/1e3,timeInfo.delta=(e-timeInfo.prev)/1e3,timeInfo.prev=e,animating&&window.setTimeout(animate,1e3/60),render()}function makeCanvasFullScreen(e){var r=document.body,t=document.documentElement;fullw=Math.max(r.clientWidth,r.scrollWidth,t.scrollWidth,t.clientWidth),fullh=Math.max(r.clientHeight,r.scrollHeight,t.scrollHeight,t.clientHeight),e.width=fullw,e.height=fullh}var Vector3={},Matrix44={};Vector3.create=function(e,r,t){return{x:e,y:r,z:t}},Vector3.dot=function(e,r){return e.x*r.x+e.y*r.y+e.z*r.z},Vector3.cross=function(e,r,t){e.x=r.y*t.z-r.z*t.y,e.y=r.z*t.x-r.x*t.z,e.z=r.x*t.y-r.y*t.x},Vector3.normalize=function(e){var r=e.x*e.x+e.y*e.y+e.z*e.z;r>1e-5&&(r=1/Math.sqrt(r),e.x*=r,e.y*=r,e.z*=r)},Vector3.arrayForm=function(e){return e.array?(e.array[0]=e.x,e.array[1]=e.y,e.array[2]=e.z):e.array=new Float32Array([e.x,e.y,e.z]),e.array},Matrix44.createIdentity=function(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},Matrix44.loadProjection=function(e,r,t,o,a){var n=o*Math.tan(t*Math.PI/180*.5)*2,i=n*r;e[0]=2*o/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*o/n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=-(a+o)/(a-o),e[11]=-1,e[12]=0,e[13]=0,e[14]=-2*a*o/(a-o),e[15]=0},Matrix44.loadLookAt=function(e,r,t,o){var a=Vector3.create(r.x-t.x,r.y-t.y,r.z-t.z);Vector3.normalize(a);var n=Vector3.create(1,0,0);Vector3.cross(n,o,a),Vector3.normalize(n);var i=Vector3.create(1,0,0);Vector3.cross(i,a,n),Vector3.normalize(i),e[0]=n.x,e[1]=i.x,e[2]=a.x,e[3]=0,e[4]=n.y,e[5]=i.y,e[6]=a.y,e[7]=0,e[8]=n.z,e[9]=i.z,e[10]=a.z,e[11]=0,e[12]=-(r.x*e[0]+r.y*e[4]+r.z*e[8]),e[13]=-(r.x*e[1]+r.y*e[5]+r.z*e[9]),e[14]=-(r.x*e[2]+r.y*e[6]+r.z*e[10]),e[15]=1};var timeInfo={start:0,prev:0,delta:0,elapsed:0},gl,renderSpec={width:0,height:0,aspect:1,array:new Float32Array(3),halfWidth:0,halfHeight:0,halfArray:new Float32Array(3)};renderSpec.setSize=function(e,r){renderSpec.width=e,renderSpec.height=r,renderSpec.aspect=renderSpec.width/renderSpec.height,renderSpec.array[0]=renderSpec.width,renderSpec.array[1]=renderSpec.height,renderSpec.array[2]=renderSpec.aspect,renderSpec.halfWidth=Math.floor(e/2),renderSpec.halfHeight=Math.floor(r/2),renderSpec.halfArray[0]=renderSpec.halfWidth,renderSpec.halfArray[1]=renderSpec.halfHeight,renderSpec.halfArray[2]=renderSpec.halfWidth/renderSpec.halfHeight};var projection={angle:60,nearfar:new Float32Array([.1,100]),matrix:Matrix44.createIdentity()},camera={position:Vector3.create(0,0,100),lookat:Vector3.create(0,0,0),up:Vector3.create(0,1,0),dof:Vector3.create(10,4,8),matrix:Matrix44.createIdentity()},pointFlower={},meshFlower={},sceneStandBy=!1,BlossomParticle=function(){this.velocity=new Array(3),this.rotation=new Array(3),this.position=new Array(3),this.euler=new Array(3),this.size=1,this.alpha=1,this.zkey=0};BlossomParticle.prototype.setVelocity=function(e,r,t){this.velocity[0]=e,this.velocity[1]=r,this.velocity[2]=t},BlossomParticle.prototype.setRotation=function(e,r,t){this.rotation[0]=e,this.rotation[1]=r,this.rotation[2]=t},BlossomParticle.prototype.setPosition=function(e,r,t){this.position[0]=e,this.position[1]=r,this.position[2]=t},BlossomParticle.prototype.setEulerAngles=function(e,r,t){this.euler[0]=e,this.euler[1]=r,this.euler[2]=t},BlossomParticle.prototype.setSize=function(e){this.size=e},BlossomParticle.prototype.update=function(e,r){this.position[0]+=this.velocity[0]*e,this.position[1]+=this.velocity[1]*e,this.position[2]+=this.velocity[2]*e,this.euler[0]+=this.rotation[0]*e,this.euler[1]+=this.rotation[1]*e,this.euler[2]+=this.rotation[2]*e};var effectLib={},postProcess={},SceneEnv={},animating=!0;$(function(){var e=document.getElementById("sakura");try{makeCanvasFullScreen(e),gl=e.getContext("experimental-webgl")}catch(e){return alert("WebGL not supported."+e),void console.error(e)}window.addEventListener("resize",onResize),setViewports(),createScene(),initScene(),timeInfo.start=new Date,timeInfo.prev=timeInfo.start,animate()});